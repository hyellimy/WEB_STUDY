# 2018.10.12 금요일

# 서블릿

### 서블릿 응답 메시지 처리

* ### 한글 처리를 위한 메소드 추가

  * PrintWriter 전에 

  * ```java
    public void process(HttpServletRequest request, HttpServletResponse response) throws IOException {
    		response.setContentType("text/html; charset=utf-8");
    		request.setCharacterEncoding("utf-8"); // 한글 인코딩 처리를 가능하게 하는 처리 :-) 
    		PrintWriter out = response.getWriter();
    
    ```

* #### sendRedirect(url : String) : void

  * 브라우저 인서트 후 다시 요청하여 전송하는 처리 : Foward처리 

  * ```java
    public void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
         response.setStatus(HttpServletResponse.SC_MOVED_PERMANENTLY);
         response.setHeader(“Location”, “/someURL”);
    
         // response.sendRedirect(“/someURL”);
         // HTML META 태그와 동일 기능
         // <meta http-equiv="refresh" content="0; URL=/someURL">
    }
    ```

  * 웹 브라우저 자동 요청 처리 : direct로 처리하려면, response를 두번 써주어야 한다.

  * 두 번 작성하지 않으려면, sendRedirect사용하면된다.

  * 예) 글 작성후 목록으로 이동할 수 있도록 하는 것 


## 응용예제 ] DB와 연동 처리

* 웹 어플리케이션은 WEB-INF안에 web.xml이 있고 lib폴더가 존재해 있다. 폴더 내에 파일을 넣어주면 된다. 

* #### 방법1 ]  Connection의 오래전 방식이다. 

```java
package Lib;

import java.sql.Connection;
import java.sql.Date;
import java.sql.Driver;
import java.sql.DriverManager;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;

import oracle.jdbc.driver.OracleDriver;

/**
 * JDBC ARI를 이용한 DBMS 연동
 * 
 * @author 이혜림
 *
 */
public class JDBCExample {

	public static void main(String[] args) throws ClassNotFoundException, SQLException, InstantiationException, IllegalAccessException {
		// #1.JDBC드라이버 로딩(객체생성)
//		Driver driver = new OracleDriver();
//		System.out.println("JDBC 드라이버 생성 완료.");

		// Class 클래스를 이용한 동적 객체 생성
		String driver = "oracle.jdbc.driver.OracleDriver";
		String url = "jdbc:oracle:thin:@localhost:1521:xe";// IP:포트번호:xe버전
		String username = "hr";
		String password = "hr";
		String sql = "SELECT e.employee_id     id, \r\n" + 
					 "       e.last_name       ename, \r\n" + 
					 "       e.salary          salary, \r\n" + 
					 "    TO_CHAR(e.hire_date,'YYYY-MM-DD HH24:MI:SS')   hiredate, \r\n" + 
					 "       d.department_name dname \r\n" + 
					 "FROM   employees e \r\n" + 
					 "       join departments d \r\n" + 
					 "         ON e.department_id = d.department_id";

		Class.forName(driver).newInstance(); // 정확한 FULLName
		//2. DBMS연결
		Connection con = null;
		Statement stmt = null;
		ResultSet rs = null;
		
		con = DriverManager.getConnection(url, username, password);
		stmt = con.createStatement();
		rs = stmt.executeQuery(sql);

		while (rs.next()) {// 가져올 내용이 있으면,
			String employeeId = rs.getString("id");
			String lastName = rs.getString("ename");
			int salary = rs.getInt("salary");
			String hiredate = rs.getString("hiredate");
			String departmentName = rs.getString("dname");
			
			System.out.println(employeeId + "," + lastName + ", " + salary + ", " + hiredate + ", " + departmentName);
		}
		rs.close();
		stmt.close();
		con.close();
	}
}	
```

* #### 방법1-1]

```java
package kr.or.kosta.servlet;

import java.io.IOException;
import java.io.PrintWriter;
import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.Calendar;
import java.util.Enumeration;

import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import jdk.nashorn.internal.ir.RuntimeNode.Request;

/**
 * 데이터 베이스 연결
 * @author 이혜림
 *
 */
public class DatabaseServlet extends HttpServlet {
	private static final long serialVersionUID = 1L;

	
	String driver = "oracle.jdbc.driver.OracleDriver";
	String url = "jdbc:oracle:thin:@localhost:1521:xe";// IP:포트번호:xe버전
	String username = "hr";
	String password = "hr";
	
	
	
	
	String sql = "select employee_id, last_name, salary\r\n" + "from employees";
	Connection con;
		
	@Override
	public void init() throws ServletException {
		try {
			Class.forName(driver);
			con = DriverManager.getConnection(url, username, password);
			System.out.println(con);
		} catch (Exception e) {
			e.printStackTrace();
		}
	}
	
	
	
	/** 
	 * 웹 어플리케이션은 WEB-INF 안에 web.xml이 있고 lib폴더가 존재해 있다. 
	 * 폴더 내에 파일을 넣어주면 자동으로  DB관리 가능하다. 
	 */
	protected void doGet(HttpServletRequest request, HttpServletResponse response)
			throws ServletException, IOException {
		
		PreparedStatement psmt = null;
		ResultSet rs = null;
		
		try {
			psmt = con.prepareStatement(sql);
			rs = psmt.executeQuery();
			
			/*
			while (rs.next()) {// 가져올 내용이 있으면,
				String employeeId = rs.getString("id");
				String lastName = rs.getString("ename");
				int salary = rs.getInt("salary");
				String hiredate = rs.getString("hiredate");
				String departmentName = rs.getString("dname");
				System.out.println(employeeId + "," + lastName + ", " + salary + ", " + hiredate + ", " + departmentName);
			} */
			
			
		} catch (SQLException e) {
			e.printStackTrace();
		}
		
		
		response.setContentType("text/html; charset=utf-8");
		request.setCharacterEncoding("utf-8");
		
		PrintWriter out = response.getWriter();
		
		
		out.println("<html>");
		out.println("<head>");
		out.println("<title>Servlet Programming</title>");
		out.println("<meta charset=\"utf-8\">");
		out.println("</head>");
		out.println("<body style='font-size:20pt;'>");
		out.println("<table border='1' width='50%'>");
		try {
			while(rs.next()) {
				int id = rs.getInt("employee_id");
				String lastName = rs.getString("last_name");
				int salary = rs.getInt("salary");
				out.println("<tr>");
				out.println("<td>"+id+"</td><td>"+lastName+"</td><td>"+salary+"</td>");
				out.println("</tr>");
			}
		} catch (SQLException e) {
			e.printStackTrace();
		}
		
	
		out.println("</table>");

		out.println("</ul>");
		out.println("<h2></h2>");
		out.println("</body>");
		out.println("</html>"); 
	}
	@Override
	public void destroy() {
		if(con != null) {
			try {
				con.close();
			} catch (SQLException e) {
				e.printStackTrace();
			}
		}
	}

}

```



* #### 방법2]





### 다ㅅ ㅣ 해보기 !!!!!!!!!!!11





## 서블릿 초기 설정 정보 읽기

* ServletConfig

  * 서블릿 컨테이너 초기 설정 파일에 등록한 설정 초기 정보를 제공한다. 

  * 자주 바뀌는 메소드는 설정 파일로 적용하기 -> 그 파일을 읽는 것이 서블릿 Config

  * ##### Properties에 대한 이해

    * 환경정보의 변경 내용의 저장을 위한 설정 

    * 1] config.properties -File생성 

      * ```
        #Comment
        name1=bangry
        name2=bangry
        name3=bangry
        a.b.c=xxxx
        ```

    * 2]PropertiesExample을 통해 name1의 값 읽기

      * ```java
        import java.io.FileInputStream;
        import java.io.FileNotFoundException;
        import java.io.IOException;
        import java.util.Properties;
        
        public class PropertiesExample {
        
        
        	public static void main(String[] args) throws FileNotFoundException, IOException {
        		String path = "config.properties";
        		
        		Properties prop = new Properties(); //여기서는 데이터 없지만, 
        		prop.load(new FileInputStream(path)); //여기서는 4개의 데이터가 들어온다. 
        		prop.put("last", "lastvalue");
        		
        		System.out.println(prop.getProperty("name1"));
        		prop.elements();
        	}
        
        }
        
        ```

      * static 이용해서 변경하기 !! 못따라감 ㅠㅠㅠ ok

      * ```
        import java.io.FileInputStream;
        import java.io.FileNotFoundException;
        import java.io.IOException;
        import java.util.Properties;
        
        public class PropertiesExample {
           // 제일 먼저 시작
           static {
              String path = "config.properties";
        
              Properties prop = new Properties();// 빈 맵이 생성됨
              try {
                 prop.load(new FileInputStream(path));
              } catch (FileNotFoundException e) {
                 // TODO Auto-generated catch block
                 e.printStackTrace();
              } catch (IOException e) {
                 // TODO Auto-generated catch block
                 e.printStackTrace();
              }
              prop.put("last", "lastValue");
        
              System.out.println(prop.getProperty("name1"));
              prop.elements();
           }
           public static void main(String[] args) throws FileNotFoundException, IOException {
              /*//주로 static 초기화 블록에서 진행
              String path = "config.properties";
        
              Properties prop = new Properties();// 빈 맵이 생성됨
              prop.load(new FileInputStream(path));
              prop.put("last", "lastValue");
        
              System.out.println(prop.getProperty("name1"));
              prop.elements();*/
              System.out.println("프로그램 시작됨..");
           }
        }
        ```

      * ### 이거 다시보기

      * 

* ServletConfig 의 주요 메소 

  * 서버쪽에서 사용하는 것을 properties에 저장하지 않고, web.xml에 저장한다. 

  * ServletConfig는 web.xml에서 들어온 정보를 읽어올 수 있는 역할을 하는 것!

    * web에서 <init=param> <param-name / param-value > 설정지정 해주어야 한다.

    * ```java
      package kr.or.kosta.servlet;
      
      import java.io.IOException;
      import java.io.PrintWriter;
      import java.util.Calendar;
      
      import javax.servlet.ServletConfig;
      import javax.servlet.ServletException;
      import javax.servlet.http.HttpServlet;
      import javax.servlet.http.HttpServletRequest;
      import javax.servlet.http.HttpServletResponse;
      
      public class ServletConfigServlet extends HttpServlet {
      	
      	String driver; 
      	//괄호 안에 내용 있는 걸로 ! 
      	@Override
      	public void init(ServletConfig config) throws ServletException {
      		driver = config.getInitParameter("driver");
      	
      	}
      	
      	protected void doGet(HttpServletRequest request, HttpServletResponse response)
      			throws ServletException, IOException {
      
      		System.out.println(driver);
      	}
      
      }
      ```

    * ```xml
        <servlet>
          <description></description>
          <display-name>ServletConfigServlet</display-name>
          <servlet-name>ServletConfigServlet</servlet-name>
          <servlet-class>kr.or.kosta.servlet.ServletConfigServlet</servlet-class>
          <init-param>
          	<param-name>driver</param-name>
          	<param-value>oracle.jdbc.OracleDriver</param-value>
          </init-param>
        </servlet>
        <servlet-mapping>
          <servlet-name>ServletConfigServlet</servlet-name>
          <url-pattern>/config.do</url-pattern>
        </servlet-mapping>
      ```

    * ##### MIMEServlet2의 path가 초기 parameter에 저장된다. 

      * 훨씬 더 유연한 구조로 project를 만들 수 있다. 

* init 은 한번만 호출된다. 

  * doGet 메소드 : 클라이언트 요청 시마다 받아오는 데이터 

 

* #### RequestDispatcher 메소드 

  * Foward : 기능의 위임하는 역할 

  * Include : 기능을 가져와 내 것 처럼 사용하는 것 

  * 404 에러 발생했을 때, 이유 -> "/servlet/hello.do" -> 서블릿 자체로 이해된다

    * localhost/servlet/servlet/hello.do

    * ##### 이름쓸때 유의하기

    * ```java
      package kr.or.kosta.servlet;
      
      import java.io.IOException;
      import java.io.PrintWriter;
      import java.util.Calendar;
      
      import javax.servlet.RequestDispatcher;
      import javax.servlet.ServletConfig;
      import javax.servlet.ServletException;
      import javax.servlet.http.HttpServlet;
      import javax.servlet.http.HttpServletRequest;
      import javax.servlet.http.HttpServletResponse;
      
      public class DispatchServlet extends HttpServlet {
      	
      
      	protected void doGet(HttpServletRequest request, HttpServletResponse response)
      			throws ServletException, IOException {
      
      		//디스패치 기술
      		//response.sendRedirect(location);
      		RequestDispatcher rd = request.getRequestDispatcher("hello.do");
      		rd.forward(request, response);
      	}
      }
      ```

    * #### forward기술 (기능의 위임)

      * 내용값이 변경되면서 요청 주소는 바뀌지 않도록 처리하는 것

    * #### Include 기술 (기능을 가져와 내것 처럼 사용)

      * 생성하지 않아도 생성 

      * ```java
        package kr.or.kosta.servlet;
        
        import java.io.IOException;
        import java.io.PrintWriter;
        import java.util.Calendar;
        
        import javax.servlet.RequestDispatcher;
        import javax.servlet.ServletConfig;
        import javax.servlet.ServletException;
        import javax.servlet.http.HttpServlet;
        import javax.servlet.http.HttpServletRequest;
        import javax.servlet.http.HttpServletResponse;
        
        public class DispatchServlet extends HttpServlet {
        	
        
        	protected void doGet(HttpServletRequest request, HttpServletResponse response)
        			throws ServletException, IOException {
        
        		//디스패치 기술
        		//response.sendRedirect(location);
        		RequestDispatcher rd = request.getRequestDispatcher("hello.do");
        		rd.forward(request, response);
        	}
        }
        ```

* #### ServletContext 서블릿 컨테이너 환경 정보 / 데이터 공유!!! 

  * 서블릿은 서블릿 컨테이너가 관리한다. ( servletContext :서블릿 컨테이너를 관리하는 조직도)

  * 서블릿과 관련된 모든 정보를 제공한다. 

  * 여러개의 Class가 존재할 때, A의 정보를 컨테이너에 저장하고 E가 컨테이너에서 정보를 읽어온다. 

  * ##### 주요 메서드 

–getServletName(): String

–getMajorVersion(): int

–getContextPath() : String			servletContext= 모든 서블릿을 다 공유  ( 범위가 가장 넓음)

–getServletContextName() : String

–getServletNames(): Enumeration

–getServlet(name: String): String

–getInitParameter(paramName: String): String

–getInitParameterName(): Enumeration

–getRequestDispatcher(url: String): RequestDispatcher

–getAttribute(attName: String): String		** 가장 많이 사용 (속성가져오기)

–setAttribute(attName: String, attValue: Object): void			** 가장 많이 사용 (속성 설정)

–removeAttribute(attName: String): void			** 가장 많이 사용 (속성 삭제 )

```java
public void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
     ServletContext context = getServletContext();
}
```

### 예제, Servlet CONTEXT 다시보기

```java+
package kr.or.kosta.servlet;

import java.io.IOException;


import javax.servlet.RequestDispatcher;
import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;



public class ServletContext extends HttpServlet {
	

	/**
	 * 
	 */
	private static final long serialVersionUID = 1L;

	protected void doGet(HttpServletRequest request, HttpServletResponse response)
			throws ServletException, IOException {

		
		String message = "서블릿간의 데이터 공유 입니다.";
		javax.servlet.ServletContext context = getServletContext();
		
		
		System.out.println(context.getServletContextName());
		System.out.println(context.getContextPath());
		
		context.setAttribute("message", message);
		response.sendRedirect("hello.do"); //브라우저 url을 기준으로 보는 것이다. : 상대경로로 인식한다. 
		
		
	}

}

```

## 클라이언트 상태 정보 유지

* 서블릿은 HTTP프로토콜을 사용하기 때문에, 클라이언트와 서버와의 연결관계가 지속적이지 않다. 

* ##### 문제점 : 같은 사용자가 여러번 요청하더라도 같은 사용자가 보낸 것인지 알 수 없다. 

* #### 해결방안

  * ### 해결1] 세션(HttpSession)

    * 개별 브라우져 하나 당 개별 server객체의 생성

    * servletContext의 문제 해결을 위한 것 : 다른 브라우져가 들어오면 정보가 다 날아가는 문제 해결을 위해 브라우져 하나당 하나의 서버 객체가 필요하다. 

    * #### 예제]

    * ```java
      public class HttpSesstionServlet extends HttpServlet {
      
      	protected void doGet(HttpServletRequest request, HttpServletResponse response)
      			throws ServletException, IOException {
      
      		String name = "김기정";
      		HttpSession sesstion= request.getSession();
      		
      		sesstion.setAttribute("userName", name);
          }
      }
      ```

    * 결과값이 edge에서 나올때와 Chrome에서 실행했을 때 다르게 나온다. 

      * 왜냐하면 다른 클라이언트로 인식, 스코프 문제로 인식한다. 
      * tap은 같은 걸로 인식한다. 

    * 사용)쇼핑몰에서 주로 사용한다. 장바구니에 저장한 사용자 정보가 각각의 사용자마다의 정보에 따라 각 서버에 저장해 놓는다. 

  * ### 해결2 ] 쿠키(Cookie)

    * 세션의 문제점 : 클라이언트와 서버와의 연결이 지속적이지 않다. 

    * 해결] 연결이 끊겨도 정보를 유지할 수 있도록, Cookie개념을 사용한다. 

    * 소비자가 post-it을 갖고 / 상점 거래 기록을 가질 수 있는 내용 

    * 정의: 클라이언트 상태 정보를 클라이언트의 메모리에 일정한 형식의 텍스트 데이터(쿠키)”로 저장하고, HTTP 요청 시 요청 메시지 헤더에 쿠키를 포함시켜 전송한다.

    * ```java
      package kr.or.kosta.servlet;
      
      import java.io.IOException;
      
      
      import javax.servlet.RequestDispatcher;
      import javax.servlet.ServletException;
      import javax.servlet.http.Cookie;
      import javax.servlet.http.HttpServlet;
      import javax.servlet.http.HttpServletRequest;
      import javax.servlet.http.HttpServletResponse;
      import javax.servlet.http.HttpSession;
      /**
       * 쿠키 서블릿 
       * @author 이혜림
       *
       */
      public class CookieServlet extends HttpServlet {
      
      	protected void doGet(HttpServletRequest request, HttpServletResponse response)
      			throws ServletException, IOException {
      
      		String id = "bangry"; //
      		
      		Cookie cookie = new Cookie("loginId", id);
      		//cookie.setMaxAge(60*60*24*30); // 단위는 초단위 
      		//cookie.setDomain("http://www.naver.com");
      		//cookie.setPath("/");
      		
      		//쿠키를 헤더에 밀어넣는 작업
      		response.setHeader("Set-Cookie",".......");
      		//밀어넣고~
      		response.addCookie(cookie);
      		// 보내주고~
      		response.sendRedirect("hello2");
      		
      	}
      }
      
      ```

    * ```java
      package kr.or.kosta.servlet;
      
      import java.io.IOException;
      import java.net.URLEncoder;
      
      import javax.servlet.RequestDispatcher;
      import javax.servlet.ServletException;
      import javax.servlet.http.Cookie;
      import javax.servlet.http.HttpServlet;
      import javax.servlet.http.HttpServletRequest;
      import javax.servlet.http.HttpServletResponse;
      import javax.servlet.http.HttpSession;
      /**
       * 쿠키 서블릿 
       * @author 이혜림
       *
       */
      
      
      public class CookieServlet extends HttpServlet {
      
      	protected void doGet(HttpServletRequest request, HttpServletResponse response)
      			throws ServletException, IOException {
      
      //		String id = "bangry"; //
      		String id = "방그리";
      		
      		id = URLEncoder.encode(id, "utf-8");
      		
      		Cookie cookie = new Cookie("loginId", id);
      		cookie.setMaxAge(60*60*24*30); // 단위는 초단위 
      		//cookie.setDomain("http://www.naver.com");
      //		cookie.setPath("/");
      		
      		//쿠키를 헤더에 밀어넣는 작업
      //		response.setHeader("Set-Cookie",".......");
      		//밀어넣고~
      		response.addCookie(cookie);
      		// 보내주고~
      		response.sendRedirect("hello2");
      		
      	}
      } [한글처리 ]
      ```

    * https://www.w3schools.com/js/js_cookies.asp

    * #### 실습 예제] 쿠키를 통해 브라우져 실행시 사용자별 정보 저장

      * ```java
        package kr.or.kosta.servlet;
        
        import java.io.IOException;
        import java.io.PrintWriter;
        import java.util.Calendar;
        
        import javax.servlet.ServletException;
        import javax.servlet.http.Cookie;
        import javax.servlet.http.HttpServlet;
        import javax.servlet.http.HttpServletRequest;
        import javax.servlet.http.HttpServletResponse;
        
        /**
         * Servlet implementation class HelloServlet2
         */
        public class HelloServlet2 extends HttpServlet {
        	private static final long serialVersionUID = 1L;
        
        	/**
        	 * @see HttpServlet#doGet(HttpServletRequest request, HttpServletResponse
        	 *      response)
        	 */
        	protected void doGet(HttpServletRequest request, HttpServletResponse response)
        			throws ServletException, IOException {
        
        		int count = 0;
        
        		Cookie[] cookies = request.getCookies(); // 브라우저에서 전달된 모든 쿠키 전달
        		if (cookies != null) { // 브라우저에서 전달된 쿠키정보가 있다면
        			for (Cookie cookie : cookies) {
        				if (cookie.getName().equals("count")) {
        					count = Integer.parseInt(cookie.getValue());
        					break;
        				}
        			}
        		}
        		count++;
        
        		Cookie cookie = new Cookie("count", String.valueOf(count));
        		cookie.setMaxAge(60 * 60 * 24 * 30);
        		response.addCookie(cookie);
        
        		response.setContentType("text/html; charset=utf-8");
        		request.setCharacterEncoding("utf-8");
        
        		PrintWriter out = response.getWriter();
        
        		out.println("<html>");
        		out.println("<head>");
        		out.println("<title>Servlet Programming</title>");
        		out.println("<meta charset=\"utf-8\">");
        		out.println("</head>");
        		out.println("<body style='font-size:20pt;'>");
        		out.println("<h2>당신은 " + cookie.getValue() + "번째 방문하셨습니다. </h2>");
        		out.println("</body>");
        		out.println("</html>");
        
        	}
        }
        
        ```

      * 

    * #### 실습예제2] 방그리 로그인 할 수 있도록 바꾸기 

    * 방그리 로그인 중 

    * 방그리 로그 아웃으로 화면 변경하기 
















